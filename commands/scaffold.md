---
description: Analyze existing code and generate a context agent. Usage /craftsman:scaffold <path>
---

# /craftsman:scaffold - Intelligent Agent Generation

Analyze existing code structure and generate a bounded context agent.

## Usage

```
/craftsman:scaffold <path>
```

Example:
```
/craftsman:scaffold backend/src/Domain/Gamification/
```

## Process

### Phase 1: Discovery

Scan the provided path for:

**PHP Files:**
- Classes in `Entity/` → Entities
- Classes in `ValueObject/` → Value Objects
- Classes in `Service/` → Domain Services
- Interfaces in `Repository/` → Repository interfaces
- Classes in `Event/` → Domain Events
- Classes in `Exception/` → Domain Exceptions
- Enums in `Enum/` → Enumerations

**TypeScript Files:**
- Files in `entities/` → Entities
- Files in `valueObjects/` → Value Objects
- Files with `.hook.ts` → Hooks
- Files with `.component.tsx` → Components

### Phase 2: Analysis

For each detected file:

1. **Extract class/interface name**
2. **Identify type** (Entity, VO, Service, etc.)
3. **Detect relationships** (imports, type hints)
4. **Extract public methods** (behavior surface)
5. **Identify aggregate root** (entity with most relationships)

### Phase 3: Detection Report

Present findings to user:

```markdown
## Scanning: {path}

### Detected Structure

| Type | Name | File |
|------|------|------|
| Aggregate Root | GamificationProfile | Entity/GamificationProfile.php |
| Entity | Level | Entity/Level.php |
| Entity | WeeklyCheckIn | Entity/WeeklyCheckIn.php |
| Value Object | CheckInData | ValueObject/CheckInData.php |
| Domain Service | PointCalculator | Service/PointCalculator.php |
| Repository | GamificationProfileRepositoryInterface | Repository/... |

### Missing (Recommended)

| Type | Reason |
|------|--------|
| Domain Events | No Event/ directory found |
| Exceptions | No Exception/ directory found |

### Related Paths (detected)

- Application: `{app_path}/Gamification/`
- Infrastructure: `{infra_path}/Gamification/`
- Tests: `{tests_path}/Gamification/`

Generate agent? [Y/n]
```

### Phase 4: Agent Generation

Generate `.claude/agents/agent-{context-name}.md`:

```markdown
# Agent: {Context} Context

> Auto-generated by /craftsman:scaffold
> Source: {path}
> Generated: {date}

## Mission

Maintain and extend the {Context} bounded context.

## Architecture

### Aggregate Root
- `{AggregateRoot}` - {brief description from class}

### Entities
| Entity | Purpose |
|--------|---------|
{for each entity}
| {Name} | {extracted from class doc or inferred} |
{/for}

### Value Objects
{list}

### Domain Services
{list}

### Repositories
{list}

### Domain Events
{list or "⚠️ None detected - consider adding"}

## Key Invariants

{Extracted from validation logic, constructor guards, etc.}

## Related Files

```
{app_path}/{Context}/    → Use Cases
{infra_path}/{Context}/  → Implementations
{tests_path}/{Context}/  → Tests
```

## Validation Commands

```bash
make phpstan
make test -- --filter={Context}
```

## Warnings

{List any detected issues: missing events, missing tests, etc.}
```

### Phase 5: Save & Report

1. Create `.claude/agents/` directory if needed
2. Write agent file
3. Report success:

```
✓ Agent created: .claude/agents/agent-gamification.md

Contents:
- 1 aggregate root
- 3 entities
- 1 value object
- 1 domain service
- 4 repository interfaces
- ⚠️ 0 domain events (consider adding)

The agent is now available as context for this bounded context.
```

## Options

```
/craftsman:scaffold <path> --dry-run    # Preview without creating file
/craftsman:scaffold <path> --force      # Overwrite existing agent
/craftsman:scaffold <path> --output=X   # Custom output path
```

## Error Handling

### Empty Directory
```
Error: No recognizable code structure in {path}

Expected:
- Entity/ or entities/
- ValueObject/ or valueObjects/
- Service/
- Repository/

Tip: Ensure path points to a domain bounded context.
```

### No Aggregate Root Found
```
Warning: No clear aggregate root detected.

Entities found: {list}

Please specify which is the aggregate root:
1. {Entity1}
2. {Entity2}
3. {Entity3}
```

## Integration

After generation, suggest:

```
Agent generated! Next steps:

1. Review the agent: cat .claude/agents/agent-{context}.md
2. Add missing domain events if needed
3. Use the agent as context when working on this bounded context

To use: "Read agent-{context}.md before implementing..."
```
